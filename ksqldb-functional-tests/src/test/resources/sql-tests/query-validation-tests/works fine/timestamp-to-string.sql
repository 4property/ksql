--@test: timestamp-to-string - millis to string with valid zone
CREATE STREAM INPUT (K STRING KEY, IGNORED INT) WITH (kafka_topic='input', value_format='JSON');
CREATE STREAM OUTPUT AS SELECT K, TIMESTAMPTOSTRING(ROWTIME, 'yyyy-MM-dd HH:mm:ss zzz','America/Los_Angeles') FROM input;
INSERT INTO `INPUT` (ROWTIME) VALUES (1526075913000);
ASSERT VALUES `OUTPUT` (KSQL_COL_0, ROWTIME) VALUES ('2018-05-11 14:58:33 PDT', 1526075913000);

--@test: timestamp-to-string - millis to string in join
CREATE STREAM INPUT (K STRING KEY, WLAN_SA ARRAY<VARCHAR>) WITH (kafka_topic='input', value_format='JSON');
CREATE TABLE DEVICES (ROWKEY STRING PRIMARY KEY, NAME VARCHAR) WITH (kafka_topic='devices', value_format='JSON');
CREATE TABLE OUTPUT AS SELECT D.NAME AS DEVICE_NAME, TIMESTAMPTOSTRING(MIN(P.ROWTIME),'yyyy-MM-dd HH:mm:ss zzz','Europe/London') FROM INPUT P INNER JOIN DEVICES D ON P.WLAN_SA[1] = D.ROWKEY GROUP BY D.NAME emit changes;
INSERT INTO `DEVICES` (ROWKEY, name, ROWTIME) VALUES ('a', 'device', 1526075912000);
INSERT INTO `INPUT` (K, WLAN_SA, ROWTIME) VALUES ('foo', ARRAY['a'], 1526075913000);
ASSERT VALUES `OUTPUT` (DEVICE_NAME, KSQL_COL_0, ROWTIME) VALUES ('device', '2018-05-11 22:58:33 BST', 1526075913000);

--@test: timestamp-to-string - timestamp to string with valid zone
CREATE STREAM INPUT (K STRING KEY, TIME TIMESTAMP) WITH (kafka_topic='input', value_format='JSON');
CREATE STREAM OUTPUT AS SELECT K, FORMAT_TIMESTAMP(TIME, 'yyyy-MM-dd HH:mm:ss zzz','America/Los_Angeles') FROM input;
INSERT INTO `INPUT` (time, ROWTIME) VALUES ('2018-05-11T21:58:33.000', 1526075913000);
INSERT INTO `INPUT` (time, ROWTIME) VALUES (NULL, 1526075913000);
ASSERT VALUES `OUTPUT` (KSQL_COL_0, ROWTIME) VALUES ('2018-05-11 14:58:33 PDT', 1526075913000);
ASSERT VALUES `OUTPUT` (KSQL_COL_0, ROWTIME) VALUES (NULL, 1526075913000);

--@test: timestamp-to-string - timestamp to string without a time zone
CREATE STREAM INPUT (K STRING KEY, TIME TIMESTAMP) WITH (kafka_topic='input', value_format='JSON');
CREATE STREAM OUTPUT AS SELECT K, FORMAT_TIMESTAMP(TIME, 'yyyy-MM-dd HH:mm:ss') FROM input;
INSERT INTO `INPUT` (time, ROWTIME) VALUES ('2018-05-11T21:58:33.000', 1526075913000);
INSERT INTO `INPUT` (time, ROWTIME) VALUES (NULL, 1526075913000);
ASSERT VALUES `OUTPUT` (KSQL_COL_0, ROWTIME) VALUES ('2018-05-11 21:58:33', 1526075913000);
ASSERT VALUES `OUTPUT` (KSQL_COL_0, ROWTIME) VALUES (NULL, 1526075913000);

