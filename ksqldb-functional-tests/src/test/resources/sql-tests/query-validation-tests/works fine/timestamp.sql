--@test: timestamp - DELIMITED in/out
CREATE STREAM TEST (ID STRING KEY, time TIMESTAMP) WITH (kafka_topic='test', value_format='DELIMITED');
CREATE STREAM TEST2 AS SELECT * FROM TEST;
INSERT INTO `TEST` (TIME) VALUES ('1970-01-01T00:00:00.010');
ASSERT VALUES `TEST2` (TIME) VALUES ('1970-01-01T00:00:00.010');

--@test: timestamp - AVRO in/out
CREATE STREAM TEST (ID STRING KEY, time TIMESTAMP) WITH (kafka_topic='test', value_format='AVRO');
CREATE STREAM TEST2 AS SELECT * FROM TEST;
INSERT INTO `TEST` (TIME) VALUES ('1970-01-01T00:00:00.010');
ASSERT VALUES `TEST2` (TIME) VALUES ('1970-01-01T00:00:00.010');

--@test: timestamp - JSON in/out
CREATE STREAM TEST (ID STRING KEY, time TIMESTAMP) WITH (kafka_topic='test', value_format='JSON');
CREATE STREAM TEST2 AS SELECT * FROM TEST;
INSERT INTO `TEST` (time) VALUES ('1970-01-01T00:00:00.010');
ASSERT VALUES `TEST2` (TIME) VALUES ('1970-01-01T00:00:00.010');

--@test: timestamp - PROTOBUF in/out
CREATE STREAM TEST (ID STRING KEY, time TIMESTAMP) WITH (kafka_topic='test', value_format='PROTOBUF');
CREATE STREAM TEST2 AS SELECT * FROM TEST;
INSERT INTO `TEST` (time) VALUES ('1970-01-01T00:00:00.010');
ASSERT VALUES `TEST2` (TIME) VALUES ('1970-01-01T00:00:00.010');

--@test: timestamp - equal - timestamp timestamp
CREATE STREAM TEST (ID STRING KEY, a TIMESTAMP, b TIMESTAMP) WITH (kafka_topic='test', value_format='AVRO');
CREATE STREAM TEST2 AS SELECT ID, (a = b) AS RESULT FROM TEST;
INSERT INTO `TEST` (A, B) VALUES ('1970-01-01T00:00:00.010', '1970-01-01T00:00:00.010');
INSERT INTO `TEST` (A, B) VALUES ('1970-01-01T00:00:00.010', '1970-01-01T00:00:00.100');
INSERT INTO `TEST` (A, B) VALUES (NULL, '1970-01-01T00:00:00.100');
INSERT INTO `TEST` (A, B) VALUES (NULL, NULL);
ASSERT VALUES `TEST2` (RESULT) VALUES (true);
ASSERT VALUES `TEST2` (RESULT) VALUES (false);
ASSERT VALUES `TEST2` (RESULT) VALUES (false);
ASSERT VALUES `TEST2` (RESULT) VALUES (false);

--@test: timestamp - not equal - timestamp timestamp
CREATE STREAM TEST (ID STRING KEY, a TIMESTAMP, b TIMESTAMP) WITH (kafka_topic='test', value_format='AVRO');
CREATE STREAM TEST2 AS SELECT ID, (a <> b) AS RESULT FROM TEST;
INSERT INTO `TEST` (A, B) VALUES ('1970-01-01T00:00:00.010', '1970-01-01T00:00:00.010');
INSERT INTO `TEST` (A, B) VALUES ('1970-01-01T00:00:00.010', '1970-01-01T00:00:00.012');
INSERT INTO `TEST` (A, B) VALUES (NULL, '1970-01-01T00:00:00.010');
INSERT INTO `TEST` (A, B) VALUES (NULL, NULL);
ASSERT VALUES `TEST2` (RESULT) VALUES (false);
ASSERT VALUES `TEST2` (RESULT) VALUES (true);
ASSERT VALUES `TEST2` (RESULT) VALUES (false);
ASSERT VALUES `TEST2` (RESULT) VALUES (false);

--@test: timestamp - is distinct - decimal decimal
CREATE STREAM TEST (ID STRING KEY, a TIMESTAMP, b TIMESTAMP) WITH (kafka_topic='test', value_format='AVRO');
CREATE STREAM TEST2 AS SELECT ID, (a IS DISTINCT FROM b) AS RESULT FROM TEST;
INSERT INTO `TEST` (A, B) VALUES ('1970-01-01T00:00:00.010', '1970-01-01T00:00:00.010');
INSERT INTO `TEST` (A, B) VALUES ('1970-01-01T00:00:00.010', '1970-01-01T00:00:00.012');
INSERT INTO `TEST` (A, B) VALUES (NULL, '1970-01-01T00:00:00.010');
INSERT INTO `TEST` (A, B) VALUES (NULL, NULL);
ASSERT VALUES `TEST2` (RESULT) VALUES (false);
ASSERT VALUES `TEST2` (RESULT) VALUES (true);
ASSERT VALUES `TEST2` (RESULT) VALUES (true);
ASSERT VALUES `TEST2` (RESULT) VALUES (false);

--@test: timestamp - less than - timestamp timestamp
CREATE STREAM TEST (ID STRING KEY, a TIMESTAMP, b TIMESTAMP) WITH (kafka_topic='test', value_format='AVRO');
CREATE STREAM TEST2 AS SELECT ID, (a < b) AS RESULT FROM TEST;
INSERT INTO `TEST` (A, B) VALUES ('1970-01-01T00:00:00.010', '1970-01-01T00:00:00.010');
INSERT INTO `TEST` (A, B) VALUES ('1970-01-01T00:00:00.010', '1970-01-01T00:00:00.012');
INSERT INTO `TEST` (A, B) VALUES (NULL, '1970-01-01T00:00:00.010');
INSERT INTO `TEST` (A, B) VALUES (NULL, NULL);
ASSERT VALUES `TEST2` (RESULT) VALUES (false);
ASSERT VALUES `TEST2` (RESULT) VALUES (true);
ASSERT VALUES `TEST2` (RESULT) VALUES (false);
ASSERT VALUES `TEST2` (RESULT) VALUES (false);

--@test: timestamp - LEQ - decimal decimal
CREATE STREAM TEST (ID STRING KEY, a TIMESTAMP, b TIMESTAMP) WITH (kafka_topic='test', value_format='AVRO');
CREATE STREAM TEST2 AS SELECT ID, (a <= b) AS RESULT FROM TEST;
INSERT INTO `TEST` (A, B) VALUES ('1970-01-01T00:00:00.010', '1970-01-01T00:00:00.003');
INSERT INTO `TEST` (A, B) VALUES ('1970-01-01T00:00:00.010', '1970-01-01T00:00:00.010');
INSERT INTO `TEST` (A, B) VALUES ('1970-01-01T00:00:00.010', '1970-01-01T00:00:00.012');
INSERT INTO `TEST` (A, B) VALUES (NULL, '1970-01-01T00:00:00.010');
INSERT INTO `TEST` (A, B) VALUES (NULL, NULL);
ASSERT VALUES `TEST2` (RESULT) VALUES (false);
ASSERT VALUES `TEST2` (RESULT) VALUES (true);
ASSERT VALUES `TEST2` (RESULT) VALUES (true);
ASSERT VALUES `TEST2` (RESULT) VALUES (false);
ASSERT VALUES `TEST2` (RESULT) VALUES (false);

--@test: timestamp - GEQ - timestamp timestamp
CREATE STREAM TEST (ID STRING KEY, a TIMESTAMP, b TIMESTAMP) WITH (kafka_topic='test', value_format='AVRO');
CREATE STREAM TEST2 AS SELECT ID, (a >= b) AS RESULT FROM TEST;
INSERT INTO `TEST` (A, B) VALUES ('1970-01-01T00:00:00.010', '1970-01-01T00:00:00.003');
INSERT INTO `TEST` (A, B) VALUES ('1970-01-01T00:00:00.010', '1970-01-01T00:00:00.010');
INSERT INTO `TEST` (A, B) VALUES ('1970-01-01T00:00:00.010', '1970-01-01T00:00:00.012');
INSERT INTO `TEST` (A, B) VALUES (NULL, '1970-01-01T00:00:00.010');
INSERT INTO `TEST` (A, B) VALUES (NULL, NULL);
ASSERT VALUES `TEST2` (RESULT) VALUES (true);
ASSERT VALUES `TEST2` (RESULT) VALUES (true);
ASSERT VALUES `TEST2` (RESULT) VALUES (false);
ASSERT VALUES `TEST2` (RESULT) VALUES (false);
ASSERT VALUES `TEST2` (RESULT) VALUES (false);

--@test: timestamp - greater than - timestamp timestamp
CREATE STREAM TEST (ID STRING KEY, a TIMESTAMP, b TIMESTAMP) WITH (kafka_topic='test', value_format='AVRO');
CREATE STREAM TEST2 AS SELECT ID, (a > b) AS RESULT FROM TEST;
INSERT INTO `TEST` (A, B) VALUES ('1970-01-01T00:00:00.010', '1970-01-01T00:00:00.003');
INSERT INTO `TEST` (A, B) VALUES ('1970-01-01T00:00:00.010', '1970-01-01T00:00:00.010');
INSERT INTO `TEST` (A, B) VALUES ('1970-01-01T00:00:00.010', '1970-01-01T00:00:00.012');
INSERT INTO `TEST` (A, B) VALUES (NULL, '1970-01-01T00:00:00.010');
INSERT INTO `TEST` (A, B) VALUES (NULL, NULL);
ASSERT VALUES `TEST2` (RESULT) VALUES (true);
ASSERT VALUES `TEST2` (RESULT) VALUES (false);
ASSERT VALUES `TEST2` (RESULT) VALUES (false);
ASSERT VALUES `TEST2` (RESULT) VALUES (false);
ASSERT VALUES `TEST2` (RESULT) VALUES (false);

--@test: timestamp - greater than - timestamp string
CREATE STREAM TEST (ID STRING KEY, a TIMESTAMP) WITH (kafka_topic='test', value_format='AVRO');
CREATE STREAM TEST2 AS SELECT ID, (a > '1970-01-01T00:00:00.010') AS RESULT FROM TEST;
INSERT INTO `TEST` (A) VALUES ('1970-01-01T00:00:00.010');
INSERT INTO `TEST` (A) VALUES ('1970-01-01T00:00:00.011');
INSERT INTO `TEST` (A) VALUES ('1970-01-01T00:00:00.009');
INSERT INTO `TEST` (A) VALUES (NULL);
ASSERT VALUES `TEST2` (RESULT) VALUES (false);
ASSERT VALUES `TEST2` (RESULT) VALUES (true);
ASSERT VALUES `TEST2` (RESULT) VALUES (false);
ASSERT VALUES `TEST2` (RESULT) VALUES (false);

--@test: timestamp - casting - timestamp to string
CREATE STREAM TEST (ID STRING KEY, TIME TIMESTAMP) WITH (kafka_topic='test', value_format='AVRO');
CREATE STREAM TEST2 AS SELECT ID, CAST(TIME AS STRING) AS RESULT FROM TEST;
INSERT INTO `TEST` (TIME) VALUES ('1970-01-01T00:00:00.010');
INSERT INTO `TEST` (TIME) VALUES (NULL);
ASSERT VALUES `TEST2` (RESULT) VALUES ('1970-01-01T00:00:00.010');
ASSERT VALUES `TEST2` (RESULT) VALUES (NULL);

--@test: timestamp - casting - string to timestamp
CREATE STREAM TEST (ID STRING KEY, TIME STRING) WITH (kafka_topic='test', value_format='AVRO');
CREATE STREAM TEST2 AS SELECT ID, CAST(TIME AS TIMESTAMP) AS RESULT FROM TEST;
INSERT INTO `TEST` (TIME) VALUES ('foo');
INSERT INTO `TEST` (TIME) VALUES ('1970-01-01T00:00:00.010');
INSERT INTO `TEST` (TIME) VALUES ('1970-01-01T00:00:01');
INSERT INTO `TEST` (TIME) VALUES (NULL);
ASSERT VALUES `TEST2` (RESULT) VALUES (NULL);
ASSERT VALUES `TEST2` (RESULT) VALUES ('1970-01-01T00:00:00.010');
ASSERT VALUES `TEST2` (RESULT) VALUES ('1970-01-01T00:00:01.000');
ASSERT VALUES `TEST2` (RESULT) VALUES (NULL);

--@test: timestamp - filter
CREATE STREAM TEST (ID STRING KEY, TIME TIMESTAMP) WITH (kafka_topic='test', value_format='AVRO');
CREATE STREAM TEST2 AS SELECT * FROM TEST WHERE TIME='1970-01-01T00:00:00.010';
INSERT INTO `TEST` (TIME) VALUES ('1970-01-01T00:00:00.010');
INSERT INTO `TEST` (TIME) VALUES ('1970-01-01T00:00:00.011');
INSERT INTO `TEST` (TIME) VALUES (NULL);
ASSERT VALUES `TEST2` (TIME) VALUES ('1970-01-01T00:00:00.010');

--@test: timestamp - between
CREATE STREAM TEST (ID STRING KEY, TIME TIMESTAMP) WITH (kafka_topic='test', value_format='AVRO');
CREATE STREAM TEST2 AS SELECT * FROM TEST WHERE TIME BETWEEN '1970-01-01T00:00:00.005' AND '1970-01-01T00:00:00.010';
INSERT INTO `TEST` (TIME) VALUES ('1970-01-01T00:00:00.001');
INSERT INTO `TEST` (TIME) VALUES ('1970-01-01T00:00:00.006');
INSERT INTO `TEST` (TIME) VALUES ('1970-01-01T00:00:00.012');
INSERT INTO `TEST` (TIME) VALUES (NULL);
ASSERT VALUES `TEST2` (TIME) VALUES ('1970-01-01T00:00:00.006');

--@test: timestamp - timestamp in complex types
CREATE STREAM TEST (ID STRING KEY, S STRUCT<TIME TIMESTAMP>, A ARRAY<TIMESTAMP>, M MAP<STRING, TIMESTAMP>) WITH (kafka_topic='test', value_format='AVRO');
CREATE STREAM TEST2 AS SELECT ID, S -> TIME AS S, A[1] AS A, M['TIME'] AS M FROM TEST;
INSERT INTO `TEST` (S, A, M) VALUES (STRUCT(TIME:='1970-01-01T00:00:00.001'), ARRAY['1970-01-01T00:00:00.005', '1970-01-01T00:00:00.010'], MAP('TIME':='1970-01-01T00:00:00.004'));
ASSERT VALUES `TEST2` (S, A, M) VALUES ('1970-01-01T00:00:00.001', '1970-01-01T00:00:00.005', '1970-01-01T00:00:00.004');

