--@test: geodistance - geo distance with radius
SET 'use.exact.numeric.comparison' = 'false';CREATE STREAM TEST (K STRING KEY, ID bigint, LAT1 double, LON1 double, LAT2 double, LON2 double, RADIUS varchar) WITH (kafka_topic='test_topic', value_format='JSON');
CREATE STREAM DISTANCE_STREAM AS select K, ID, geo_distance(LAT1, LON1, LAT2, LON2, RADIUS) as CALCULATED_DISTANCE from test;
INSERT INTO `TEST` (ID, LAT1, LON1, LAT2, LON2) VALUES (1, 37.4439, -122.1663, 51.5257, -0.1122);
INSERT INTO `TEST` (ID, LAT1, LON1, LAT2, LON2, RADIUS) VALUES (2, 37.4439, -122.1663, 51.5257, -0.1122, 'KM');
INSERT INTO `TEST` (ID, LAT1, LON1, LAT2, LON2, RADIUS) VALUES (3, 37.4439, -122.1663, 51.5257, -0.1122, 'MI');
INSERT INTO `TEST` (ID, LAT1, LON1, LAT2, LON2) VALUES (4, 51.5257, -0.1122, -33.9323, 18.4197);
INSERT INTO `TEST` (ID, LAT1, LON1, LAT2, LON2, RADIUS) VALUES (5, 51.5257, -0.1122, -33.9323, 18.4197, 'KM');
INSERT INTO `TEST` (ID, LAT1, LON1, LAT2, LON2, RADIUS) VALUES (6, 51.5257, -0.1122, -33.9323, 18.4197, 'MI');
INSERT INTO `TEST` (ID, LAT1, LON1, LAT2, LON2) VALUES (7, -33.9323, 18.4197, -33.8666, 151.1);
INSERT INTO `TEST` (ID, LAT1, LON1, LAT2, LON2, RADIUS) VALUES (8, -33.9323, 18.4197, -33.8666, 151.1, 'KM');
INSERT INTO `TEST` (ID, LAT1, LON1, LAT2, LON2, RADIUS) VALUES (9, -33.9323, 18.4197, -33.8666, 151.1, 'MI');
ASSERT VALUES `DISTANCE_STREAM` (ID, CALCULATED_DISTANCE) VALUES (1, 8634.659796579544);
ASSERT VALUES `DISTANCE_STREAM` (ID, CALCULATED_DISTANCE) VALUES (2, 8634.659796579544);
ASSERT VALUES `DISTANCE_STREAM` (ID, CALCULATED_DISTANCE) VALUES (3, 5365.659729188262);
ASSERT VALUES `DISTANCE_STREAM` (ID, CALCULATED_DISTANCE) VALUES (4, 9673.40421197142);
ASSERT VALUES `DISTANCE_STREAM` (ID, CALCULATED_DISTANCE) VALUES (5, 9673.40421197142);
ASSERT VALUES `DISTANCE_STREAM` (ID, CALCULATED_DISTANCE) VALUES (6, 6011.1453892944355);
ASSERT VALUES `DISTANCE_STREAM` (ID, CALCULATED_DISTANCE) VALUES (7, 11005.23304055582);
ASSERT VALUES `DISTANCE_STREAM` (ID, CALCULATED_DISTANCE) VALUES (8, 11005.23304055582);
ASSERT VALUES `DISTANCE_STREAM` (ID, CALCULATED_DISTANCE) VALUES (9, 6838.756491533589);

--@test: geodistance - geo distance without radius
SET 'use.exact.numeric.comparison' = 'false';CREATE STREAM TEST (K STRING KEY, ID bigint, LAT1 double, LON1 double, LAT2 double, LON2 double) WITH (kafka_topic='test_topic', value_format='JSON');
CREATE STREAM DISTANCE_STREAM AS select K, ID, geo_distance(LAT1, LON1, LAT2, LON2) as CALCULATED_DISTANCE from test;
INSERT INTO `TEST` (ID, LAT1, LON1, LAT2, LON2) VALUES (1, 37.4439, -122.1663, 51.5257, -0.1122);
INSERT INTO `TEST` (ID, LAT1, LON1, LAT2, LON2) VALUES (2, 51.5257, -0.1122, -33.9323, 18.4197);
INSERT INTO `TEST` (ID, LAT1, LON1, LAT2, LON2) VALUES (3, -33.9323, 18.4197, -33.8666, 151.1);
ASSERT VALUES `DISTANCE_STREAM` (ID, CALCULATED_DISTANCE) VALUES (1, 8634.659796579544);
ASSERT VALUES `DISTANCE_STREAM` (ID, CALCULATED_DISTANCE) VALUES (2, 9673.40421197142);
ASSERT VALUES `DISTANCE_STREAM` (ID, CALCULATED_DISTANCE) VALUES (3, 11005.23304055582);

--@test: geodistance - small distances in where
SET 'use.exact.numeric.comparison' = 'false';
CREATE STREAM INPUT (IGNORED INT) WITH (kafka_topic='test_topic', value_format='JSON');
CREATE STREAM OUTPUT AS select GEO_DISTANCE(39.18660374, -76.73262144, 39.18660374, -76.73222145 ) AS D from INPUT WHERE  GEO_DISTANCE(39.18660374, -76.73262144, 39.18660374, -76.73222145 ) < 0.4;
INSERT INTO `INPUT` (ignored) VALUES (33);
ASSERT VALUES `OUTPUT` (D) VALUES (0.03447366811448324);

