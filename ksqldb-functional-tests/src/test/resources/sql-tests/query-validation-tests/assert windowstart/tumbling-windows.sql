--@test: tumbling-windows - out of order - no grace period
CREATE STREAM TEST (ID BIGINT KEY, VALUE bigint) WITH (kafka_topic='test_topic', value_format='DELIMITED');
CREATE TABLE S2 as SELECT ID, max(value) FROM test WINDOW TUMBLING (SIZE 30 SECONDS) group by id;
INSERT INTO `TEST` (ID, VALUE, ROWTIME) VALUES (0, 0, 0);
INSERT INTO `TEST` (ID, VALUE, ROWTIME) VALUES (0, 1, 89999);
INSERT INTO `TEST` (ID, VALUE, ROWTIME) VALUES (0, 5, 10009);
INSERT INTO `TEST` (ID, VALUE, ROWTIME) VALUES (0, 0, 90000);
INSERT INTO `TEST` (ID, VALUE, ROWTIME) VALUES (0, 6, 10010);
INSERT INTO `TEST` (ID, VALUE, ROWTIME) VALUES (1, 100, 10009);
INSERT INTO `TEST` (ID, VALUE, ROWTIME) VALUES (1, 101, 30000);
INSERT INTO `TEST` (ID, VALUE, ROWTIME) VALUES (1, 200, 86412022);
INSERT INTO `TEST` (ID, VALUE, ROWTIME) VALUES (1, 200, 60000);
ASSERT VALUES `S2` (ID, KSQL_COL_0, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (0, 0, 0, 0, 30000);
ASSERT VALUES `S2` (ID, KSQL_COL_0, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (0, 1, 89999, 60000, 90000);
ASSERT VALUES `S2` (ID, KSQL_COL_0, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (0, 5, 10009, 0, 30000);
ASSERT VALUES `S2` (ID, KSQL_COL_0, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (0, 0, 90000, 90000, 120000);
ASSERT VALUES `S2` (ID, KSQL_COL_0, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (0, 6, 10010, 0, 30000);
ASSERT VALUES `S2` (ID, KSQL_COL_0, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (1, 100, 10009, 0, 30000);
ASSERT VALUES `S2` (ID, KSQL_COL_0, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (1, 101, 30000, 30000, 60000);
ASSERT VALUES `S2` (ID, KSQL_COL_0, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (1, 200, 86412022, 86400000, 86430000);
ASSERT VALUES `S2` (ID, KSQL_COL_0, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (1, 200, 60000, 60000, 90000);

--@test: tumbling-windows - out of order - explicit grace period
CREATE STREAM TEST (ID BIGINT KEY, VALUE bigint) WITH (kafka_topic='test_topic', value_format='DELIMITED');
CREATE TABLE S2 as SELECT ID, max(value) FROM test WINDOW TUMBLING (SIZE 30 SECONDS, GRACE PERIOD 1 MINUTE) group by id;
INSERT INTO `TEST` (ID, VALUE, ROWTIME) VALUES (0, 0, 0);
INSERT INTO `TEST` (ID, VALUE, ROWTIME) VALUES (0, 1, 89999);
INSERT INTO `TEST` (ID, VALUE, ROWTIME) VALUES (0, 5, 10009);
INSERT INTO `TEST` (ID, VALUE, ROWTIME) VALUES (0, 0, 90000);
INSERT INTO `TEST` (ID, VALUE, ROWTIME) VALUES (0, 6, 10010);
INSERT INTO `TEST` (ID, VALUE, ROWTIME) VALUES (1, 100, 10009);
INSERT INTO `TEST` (ID, VALUE, ROWTIME) VALUES (1, 101, 30000);
INSERT INTO `TEST` (ID, VALUE, ROWTIME) VALUES (1, 200, 86412022);
INSERT INTO `TEST` (ID, VALUE, ROWTIME) VALUES (1, 200, 60000);
ASSERT VALUES `S2` (ID, KSQL_COL_0, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (0, 0, 0, 0, 30000);
ASSERT VALUES `S2` (ID, KSQL_COL_0, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (0, 1, 89999, 60000, 90000);
ASSERT VALUES `S2` (ID, KSQL_COL_0, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (0, 5, 10009, 0, 30000);
ASSERT VALUES `S2` (ID, KSQL_COL_0, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (0, 0, 90000, 90000, 120000);
ASSERT VALUES `S2` (ID, KSQL_COL_0, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (1, 101, 30000, 30000, 60000);
ASSERT VALUES `S2` (ID, KSQL_COL_0, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (1, 200, 86412022, 86400000, 86430000);

--@test: tumbling-windows - min tumbling
CREATE STREAM TEST (ID BIGINT KEY, NAME varchar, VALUE bigint) WITH (kafka_topic='test_topic', value_format='DELIMITED');
CREATE TABLE S2 as SELECT ID, min(value) FROM test WINDOW TUMBLING (SIZE 30 SECONDS) group by id;
INSERT INTO `TEST` (ID, NAME, VALUE, ROWTIME) VALUES (0, 'zero', 0, 0);
INSERT INTO `TEST` (ID, NAME, VALUE, ROWTIME) VALUES (0, '100', 5, 10000);
INSERT INTO `TEST` (ID, NAME, VALUE, ROWTIME) VALUES (100, '100', 100, 30000);
INSERT INTO `TEST` (ID, NAME, VALUE, ROWTIME) VALUES (100, '100', 6, 45000);
INSERT INTO `TEST` (ID, NAME, VALUE, ROWTIME) VALUES (100, '100', 300, 50000);
ASSERT VALUES `S2` (ID, KSQL_COL_0, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (0, 0, 0, 0, 30000);
ASSERT VALUES `S2` (ID, KSQL_COL_0, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (0, 0, 10000, 0, 30000);
ASSERT VALUES `S2` (ID, KSQL_COL_0, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (100, 100, 30000, 30000, 60000);
ASSERT VALUES `S2` (ID, KSQL_COL_0, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (100, 6, 45000, 30000, 60000);
ASSERT VALUES `S2` (ID, KSQL_COL_0, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (100, 6, 50000, 30000, 60000);

--@test: tumbling-windows - topk tumbling
CREATE STREAM TEST (ID BIGINT KEY, NAME varchar, VALUE double) WITH (kafka_topic='test_topic', value_format='JSON');
CREATE TABLE S2 as SELECT ID, topk(value, 2) as topk FROM test WINDOW TUMBLING (SIZE 30 SECONDS) group by id;
INSERT INTO `TEST` (ID, name, value, ROWTIME) VALUES (0, 'zero', 0, 0);
INSERT INTO `TEST` (ID, name, value, ROWTIME) VALUES (0, 'zero', 100, 0);
INSERT INTO `TEST` (ID, name, value, ROWTIME) VALUES (0, 'zero', 10, 0);
INSERT INTO `TEST` (ID, name, value, ROWTIME) VALUES (0, 'zero', 50, 30000);
ASSERT VALUES `S2` (ID, TOPK, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (0, ARRAY[0.0], 0, 0, 30000);
ASSERT VALUES `S2` (ID, TOPK, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (0, ARRAY[100.0, 0.0], 0, 0, 30000);
ASSERT VALUES `S2` (ID, TOPK, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (0, ARRAY[100.0, 10.0], 0, 0, 30000);
ASSERT VALUES `S2` (ID, TOPK, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (0, ARRAY[50.0], 30000, 30000, 60000);

--@test: tumbling-windows - topkdistinct tumbling
CREATE STREAM TEST (ID BIGINT KEY, NAME varchar, VALUE double) WITH (kafka_topic='test_topic', value_format='JSON');
CREATE TABLE S2 as SELECT ID, topkdistinct(value, 2) as topk FROM test WINDOW TUMBLING (SIZE 30 SECONDS) group by id;
INSERT INTO `TEST` (ID, name, value, ROWTIME) VALUES (0, 'zero', 0, 0);
INSERT INTO `TEST` (ID, name, value, ROWTIME) VALUES (0, 'zero', 100, 0);
INSERT INTO `TEST` (ID, name, value, ROWTIME) VALUES (0, 'zero', 10, 0);
INSERT INTO `TEST` (ID, name, value, ROWTIME) VALUES (0, 'zero', 100, 0);
INSERT INTO `TEST` (ID, name, value, ROWTIME) VALUES (0, 'zero', 100, 30000);
ASSERT VALUES `S2` (ID, TOPK, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (0, ARRAY[0.0], 0, 0, 30000);
ASSERT VALUES `S2` (ID, TOPK, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (0, ARRAY[100.0, 0.0], 0, 0, 30000);
ASSERT VALUES `S2` (ID, TOPK, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (0, ARRAY[100.0, 10.0], 0, 0, 30000);
ASSERT VALUES `S2` (ID, TOPK, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (0, ARRAY[100.0, 10.0], 0, 0, 30000);
ASSERT VALUES `S2` (ID, TOPK, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (0, ARRAY[100.0], 30000, 30000, 60000);

--@test: tumbling-windows - import tumbling stream
CREATE STREAM TEST (K INT KEY, ID bigint) WITH (kafka_topic='test_topic', value_format='DELIMITED', WINDOW_TYPE='Tumbling', WINDOW_SIZE='30 seconds');
CREATE STREAM S2 as SELECT * FROM test;
INSERT INTO `TEST` (K, ID, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (0, 1, 0, 0, 30000);
INSERT INTO `TEST` (K, ID, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (0, 2, 0, 0, 30000);
INSERT INTO `TEST` (K, ID, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (0, 3, 0, 0, 30000);
INSERT INTO `TEST` (K, ID, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (0, 4, 30000, 30000, 60000);
ASSERT VALUES `S2` (K, ID, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (0, 1, 0, 0, 30000);
ASSERT VALUES `S2` (K, ID, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (0, 2, 0, 0, 30000);
ASSERT VALUES `S2` (K, ID, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (0, 3, 0, 0, 30000);
ASSERT VALUES `S2` (K, ID, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (0, 4, 30000, 30000, 60000);
ASSERT stream S2 (K INT KEY, ID BIGINT) WITH (KAFKA_TOPIC='S2');

--@test: tumbling-windows - non-KAFKA key format
CREATE STREAM INPUT (A DECIMAL(4,2)) WITH (kafka_topic='INPUT', format='JSON');
CREATE TABLE OUTPUT AS SELECT A, COUNT() AS COUNT FROM INPUT WINDOW TUMBLING (SIZE 30 SECONDS) group by A;
INSERT INTO `INPUT` (A, ROWTIME) VALUES (12.30, 10);
INSERT INTO `INPUT` (A, ROWTIME) VALUES (12.30, 11);
INSERT INTO `INPUT` (A, ROWTIME) VALUES (1.00, 12);
ASSERT VALUES `OUTPUT` (A, COUNT, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (12.30, 1, 10, 0, 30000);
ASSERT VALUES `OUTPUT` (A, COUNT, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (12.30, 2, 11, 0, 30000);
ASSERT VALUES `OUTPUT` (A, COUNT, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (1.00, 1, 12, 0, 30000);

