--@test: hopping-windows - out of order - no grace period
CREATE STREAM TEST (ID BIGINT KEY, VALUE bigint) WITH (kafka_topic='test_topic', value_format='DELIMITED');
CREATE TABLE S2 as SELECT ID, max(value) FROM test WINDOW HOPPING (SIZE 30 SECONDS, ADVANCE BY 15 SECONDS) group by id;
INSERT INTO `TEST` (ID, VALUE, ROWTIME) VALUES (0, 0, 0);
INSERT INTO `TEST` (ID, VALUE, ROWTIME) VALUES (0, 1, 89999);
INSERT INTO `TEST` (ID, VALUE, ROWTIME) VALUES (0, 5, 10009);
INSERT INTO `TEST` (ID, VALUE, ROWTIME) VALUES (0, 0, 90000);
INSERT INTO `TEST` (ID, VALUE, ROWTIME) VALUES (0, 6, 10010);
INSERT INTO `TEST` (ID, VALUE, ROWTIME) VALUES (1, 100, 10009);
INSERT INTO `TEST` (ID, VALUE, ROWTIME) VALUES (1, 101, 30000);
INSERT INTO `TEST` (ID, VALUE, ROWTIME) VALUES (1, 200, 86412022);
INSERT INTO `TEST` (ID, VALUE, ROWTIME) VALUES (1, 200, 60000);
ASSERT VALUES `S2` (ID, KSQL_COL_0, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (0, 0, 0, 0, 30000);
ASSERT VALUES `S2` (ID, KSQL_COL_0, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (0, 1, 89999, 60000, 90000);
ASSERT VALUES `S2` (ID, KSQL_COL_0, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (0, 1, 89999, 75000, 105000);
ASSERT VALUES `S2` (ID, KSQL_COL_0, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (0, 5, 10009, 0, 30000);
ASSERT VALUES `S2` (ID, KSQL_COL_0, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (0, 1, 90000, 75000, 105000);
ASSERT VALUES `S2` (ID, KSQL_COL_0, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (0, 0, 90000, 90000, 120000);
ASSERT VALUES `S2` (ID, KSQL_COL_0, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (0, 6, 10010, 0, 30000);
ASSERT VALUES `S2` (ID, KSQL_COL_0, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (1, 100, 10009, 0, 30000);
ASSERT VALUES `S2` (ID, KSQL_COL_0, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (1, 101, 30000, 15000, 45000);
ASSERT VALUES `S2` (ID, KSQL_COL_0, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (1, 101, 30000, 30000, 60000);
ASSERT VALUES `S2` (ID, KSQL_COL_0, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (1, 200, 86412022, 86385000, 86415000);
ASSERT VALUES `S2` (ID, KSQL_COL_0, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (1, 200, 86412022, 86400000, 86430000);
ASSERT VALUES `S2` (ID, KSQL_COL_0, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (1, 200, 60000, 45000, 75000);
ASSERT VALUES `S2` (ID, KSQL_COL_0, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (1, 200, 60000, 60000, 90000);

--@test: hopping-windows - out of order - explicit grace period
CREATE STREAM TEST (ID BIGINT KEY, VALUE bigint) WITH (kafka_topic='test_topic', value_format='DELIMITED');
CREATE TABLE S2 as SELECT ID, max(value) FROM test WINDOW HOPPING (SIZE 30 SECONDS, ADVANCE BY 15 SECONDS, GRACE PERIOD 1 MINUTE) group by id;
INSERT INTO `TEST` (ID, VALUE, ROWTIME) VALUES (0, 0, 0);
INSERT INTO `TEST` (ID, VALUE, ROWTIME) VALUES (0, 1, 89999);
INSERT INTO `TEST` (ID, VALUE, ROWTIME) VALUES (0, 5, 10009);
INSERT INTO `TEST` (ID, VALUE, ROWTIME) VALUES (0, 0, 90000);
INSERT INTO `TEST` (ID, VALUE, ROWTIME) VALUES (0, 6, 10010);
INSERT INTO `TEST` (ID, VALUE, ROWTIME) VALUES (1, 100, 10009);
INSERT INTO `TEST` (ID, VALUE, ROWTIME) VALUES (1, 101, 30000);
INSERT INTO `TEST` (ID, VALUE, ROWTIME) VALUES (1, 200, 86412022);
INSERT INTO `TEST` (ID, VALUE, ROWTIME) VALUES (1, 200, 60000);
ASSERT VALUES `S2` (ID, KSQL_COL_0, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (0, 0, 0, 0, 30000);
ASSERT VALUES `S2` (ID, KSQL_COL_0, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (0, 1, 89999, 60000, 90000);
ASSERT VALUES `S2` (ID, KSQL_COL_0, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (0, 1, 89999, 75000, 105000);
ASSERT VALUES `S2` (ID, KSQL_COL_0, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (0, 5, 10009, 0, 30000);
ASSERT VALUES `S2` (ID, KSQL_COL_0, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (0, 1, 90000, 75000, 105000);
ASSERT VALUES `S2` (ID, KSQL_COL_0, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (0, 0, 90000, 90000, 120000);
ASSERT VALUES `S2` (ID, KSQL_COL_0, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (1, 101, 30000, 15000, 45000);
ASSERT VALUES `S2` (ID, KSQL_COL_0, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (1, 101, 30000, 30000, 60000);
ASSERT VALUES `S2` (ID, KSQL_COL_0, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (1, 200, 86412022, 86385000, 86415000);
ASSERT VALUES `S2` (ID, KSQL_COL_0, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (1, 200, 86412022, 86400000, 86430000);

--@test: hopping-windows - min hopping
CREATE STREAM TEST (ID BIGINT KEY, NAME varchar, VALUE bigint) WITH (kafka_topic='test_topic', value_format='DELIMITED');
CREATE TABLE S2 as SELECT ID, min(value) FROM test WINDOW HOPPING (SIZE 30 SECONDS, ADVANCE BY 10 SECONDS) group by id;
INSERT INTO `TEST` (ID, NAME, VALUE, ROWTIME) VALUES (0, 'zero', 0, 0);
INSERT INTO `TEST` (ID, NAME, VALUE, ROWTIME) VALUES (0, '100', 5, 10000);
INSERT INTO `TEST` (ID, NAME, VALUE, ROWTIME) VALUES (100, '100', 100, 30000);
ASSERT VALUES `S2` (ID, KSQL_COL_0, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (0, 0, 0, 0, 30000);
ASSERT VALUES `S2` (ID, KSQL_COL_0, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (0, 0, 10000, 0, 30000);
ASSERT VALUES `S2` (ID, KSQL_COL_0, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (0, 5, 10000, 10000, 40000);
ASSERT VALUES `S2` (ID, KSQL_COL_0, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (100, 100, 30000, 10000, 40000);
ASSERT VALUES `S2` (ID, KSQL_COL_0, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (100, 100, 30000, 20000, 50000);
ASSERT VALUES `S2` (ID, KSQL_COL_0, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (100, 100, 30000, 30000, 60000);

--@test: hopping-windows - topk hopping
CREATE STREAM TEST (ID BIGINT KEY, NAME varchar, VALUE double) WITH (kafka_topic='test_topic', value_format='JSON');
CREATE TABLE S2 as SELECT ID, topk(value, 2) as topk FROM test WINDOW HOPPING (SIZE 30 SECONDS, ADVANCE BY 10 SECONDS) group by id;
INSERT INTO `TEST` (ID, name, value, ROWTIME) VALUES (0, 'zero', 0, 0);
INSERT INTO `TEST` (ID, name, value, ROWTIME) VALUES (0, 'zero', 100, 10000);
ASSERT VALUES `S2` (ID, TOPK, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (0, ARRAY[0.0], 0, 0, 30000);
ASSERT VALUES `S2` (ID, TOPK, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (0, ARRAY[100.0, 0.0], 10000, 0, 30000);
ASSERT VALUES `S2` (ID, TOPK, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (0, ARRAY[100.0], 10000, 10000, 40000);

--@test: hopping-windows - topkdistinct hopping
CREATE STREAM TEST (ID BIGINT KEY, NAME varchar, VALUE double) WITH (kafka_topic='test_topic', value_format='JSON');
CREATE TABLE S2 as SELECT ID, topkdistinct(value, 2) as topk FROM test WINDOW HOPPING (SIZE 30 SECONDS, ADVANCE BY 10 SECONDS) group by id;
INSERT INTO `TEST` (ID, name, value, ROWTIME) VALUES (0, 'zero', 0, 0);
INSERT INTO `TEST` (ID, name, value, ROWTIME) VALUES (0, 'zero', 100, 10000);
INSERT INTO `TEST` (ID, name, value, ROWTIME) VALUES (0, 'zero', 100, 10000);
ASSERT VALUES `S2` (ID, TOPK, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (0, ARRAY[0.0], 0, 0, 30000);
ASSERT VALUES `S2` (ID, TOPK, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (0, ARRAY[100.0, 0.0], 10000, 0, 30000);
ASSERT VALUES `S2` (ID, TOPK, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (0, ARRAY[100.0], 10000, 10000, 40000);
ASSERT VALUES `S2` (ID, TOPK, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (0, ARRAY[100.0, 0.0], 10000, 0, 30000);
ASSERT VALUES `S2` (ID, TOPK, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (0, ARRAY[100.0], 10000, 10000, 40000);

--@test: hopping-windows - count
CREATE STREAM TEST (ROWKEY INT KEY, ID INT) WITH (kafka_topic='test_topic', value_format='JSON');
CREATE TABLE S2 as SELECT ID, count(1) as count FROM test WINDOW HOPPING (SIZE 5 SECOND, ADVANCE BY 1 SECONDS) group by id;
INSERT INTO `TEST` (ROWKEY, id, ROWTIME) VALUES (0, 0, 10345);
INSERT INTO `TEST` (ROWKEY, id, ROWTIME) VALUES (0, 0, 13251);
ASSERT VALUES `S2` (ID, COUNT, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (0, 1, 10345, 6000, 11000);
ASSERT VALUES `S2` (ID, COUNT, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (0, 1, 10345, 7000, 12000);
ASSERT VALUES `S2` (ID, COUNT, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (0, 1, 10345, 8000, 13000);
ASSERT VALUES `S2` (ID, COUNT, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (0, 1, 10345, 9000, 14000);
ASSERT VALUES `S2` (ID, COUNT, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (0, 1, 10345, 10000, 15000);
ASSERT VALUES `S2` (ID, COUNT, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (0, 2, 13251, 9000, 14000);
ASSERT VALUES `S2` (ID, COUNT, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (0, 2, 13251, 10000, 15000);
ASSERT VALUES `S2` (ID, COUNT, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (0, 1, 13251, 11000, 16000);
ASSERT VALUES `S2` (ID, COUNT, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (0, 1, 13251, 12000, 17000);
ASSERT VALUES `S2` (ID, COUNT, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (0, 1, 13251, 13000, 18000);

--@test: hopping-windows - import table with invalid window size
--@expected.error: io.confluent.ksql.parser.exception.ParseFailedException
--@expected.message: Configuration WINDOW_SIZE is invalid: Invalid duration: '30 bobs'. Unknown time unit: 'BOBS'
CREATE TABLE TEST (K STRING PRIMARY KEY, ID bigint, VALUE bigint) WITH (kafka_topic='test_topic', value_format='DELIMITED', WINDOW_TYPE='Hopping', WINDOW_SIZE='30 bobs');
--@test: hopping-windows - import hopping stream
CREATE STREAM TEST (K BIGINT KEY, ID bigint, VALUE bigint) WITH (kafka_topic='test_topic', value_format='DELIMITED', WINDOW_TYPE='HoPping', WINDOW_SIZE='30 seconds');
CREATE STREAM S2 as SELECT * FROM test;
INSERT INTO `TEST` (K, ID, VALUE, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (0, 1, 0, 0, 0, 30000);
INSERT INTO `TEST` (K, ID, VALUE, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (0, 2, 0, 10000, 0, 30000);
INSERT INTO `TEST` (K, ID, VALUE, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (0, 3, 5, 10000, 10000, 40000);
INSERT INTO `TEST` (K, ID, VALUE, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (100, 4, 100, 30000, 10000, 40000);
INSERT INTO `TEST` (K, ID, VALUE, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (100, 5, 100, 30000, 20000, 50000);
INSERT INTO `TEST` (K, ID, VALUE, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (100, 6, 100, 30000, 30000, 60000);
ASSERT VALUES `S2` (K, ID, VALUE, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (0, 1, 0, 0, 0, 30000);
ASSERT VALUES `S2` (K, ID, VALUE, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (0, 2, 0, 10000, 0, 30000);
ASSERT VALUES `S2` (K, ID, VALUE, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (0, 3, 5, 10000, 10000, 40000);
ASSERT VALUES `S2` (K, ID, VALUE, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (100, 4, 100, 30000, 10000, 40000);
ASSERT VALUES `S2` (K, ID, VALUE, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (100, 5, 100, 30000, 20000, 50000);
ASSERT VALUES `S2` (K, ID, VALUE, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (100, 6, 100, 30000, 30000, 60000);
ASSERT stream S2 (`K` BIGINT KEY, `ID` BIGINT, `VALUE` BIGINT) WITH (KAFKA_TOPIC='S2');

--@test: hopping-windows - non-KAFKA key format
CREATE STREAM INPUT (A DECIMAL(4,2)) WITH (kafka_topic='INPUT', format='JSON');
CREATE TABLE OUTPUT AS SELECT A, COUNT() AS COUNT FROM INPUT WINDOW HOPPING (SIZE 30 SECONDS, ADVANCE BY 15 SECONDS) group by A;
INSERT INTO `INPUT` (A, ROWTIME) VALUES (12.30, 10);
INSERT INTO `INPUT` (A, ROWTIME) VALUES (12.30, 11);
INSERT INTO `INPUT` (A, ROWTIME) VALUES (1.00, 12);
ASSERT VALUES `OUTPUT` (A, COUNT, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (12.30, 1, 10, 0, 30000);
ASSERT VALUES `OUTPUT` (A, COUNT, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (12.30, 2, 11, 0, 30000);
ASSERT VALUES `OUTPUT` (A, COUNT, ROWTIME, WINDOWSTART, WINDOWEND) VALUES (1.00, 1, 12, 0, 30000);

